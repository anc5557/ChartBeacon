---
description: ERD
globs: 
alwaysApply: false
---
# 기술적 지표 대시보드 ERD (v1.1)

---

> **DBMS** : PostgreSQL 16 ↔ SQLAlchemy ORM (asyncpg)

```mermaid
erDiagram
    %% ───────────────────────────────
    %% 1. SYMBOL MASTER
    %% ───────────────────────────────
    symbols {
        bigint id PK "serial"
        text   ticker  "005930.KS / AAPL"
        text   name    "Samsung Electronics"
        
        timestamptz created_at
    }

    %% ───────────────────────────────
    %% 2. CANDLE DATA (RAW)
    %% ───────────────────────────────
    candles_raw {
        bigint id PK
        bigint symbol_id FK
        varchar timeframe  "5m | 1h | 1d"
        timestamptz ts     "봉 마감 시각 (UTC)"
        numeric open(18,4)
        numeric high(18,4)
        numeric low(18,4)
        numeric close(18,4)
        numeric volume(18,0)
        timestamptz ingested_at
    }

    %% ───────────────────────────────
    %% 3. INDICATORS (OSCILLATORS)
    %% ───────────────────────────────
    indicators {
        bigint id PK
        bigint symbol_id FK
        varchar timeframe
        timestamptz ts
        numeric rsi14(10,4)
        numeric stoch_k(10,4)
        numeric stoch_d(10,4)
        numeric macd(12,4)
        numeric macd_signal(12,4)
        numeric adx14(10,4)
        numeric cci14(12,4)
        numeric atr14(14,4)
        numeric highlow14(12,4)
        numeric ultosc(10,4)
        numeric roc(10,4)
        numeric bull_bear(14,4)
        timestamptz calc_at
    }

    %% ───────────────────────────────
    %% 4. MOVING AVERAGES
    %% ───────────────────────────────
    moving_avgs {
        bigint id PK
        bigint symbol_id FK
        varchar timeframe
        timestamptz ts
        numeric ma5(18,4)
        numeric ema5(18,4)
        numeric ma10(18,4)
        numeric ema10(18,4)
        numeric ma20(18,4)
        numeric ema20(18,4)
        numeric ma50(18,4)
        numeric ma100(18,4)
        numeric ma200(18,4)
        timestamptz calc_at
    }

    %% ───────────────────────────────
    %% 5. SUMMARY (BUY/SELL SCORE)
    %% ───────────────────────────────
    summary {
        bigint id PK
        bigint symbol_id FK
        varchar timeframe
        timestamptz ts
        smallint buy_cnt
        smallint sell_cnt
        smallint neutral_cnt
        varchar level  "STRONG_BUY …"
        timestamptz scored_at
    }

    %% RELATIONS
    symbols ||--o{ candles_raw
    symbols ||--o{ indicators
    symbols ||--o{ moving_avgs
    symbols ||--o{ summary
```

## 필드 상세 설명

### 1. `symbols`

| 필드           | 타입            | 설명                                              |
| ------------ | ------------- | ----------------------------------------------- |
| `id`         | `bigint` (PK) | 내부 고유 식별자. `GENERATED BY DEFAULT AS IDENTITY`.  |
| `ticker`     | `text`        | 티커 코드. 한국: `005930.KS`, 미국: `AAPL` 등. `UNIQUE`. |
| `name`       | `text`        | 종목(또는 ETF) 전체 이름.                               |
| `created_at` | `timestamptz` | 해당 심볼이 처음 등록된 시각 (UTC).                         |

### 2. `candles_raw`

| 필드            | 타입                       | 설명                                                             |
| ------------- | ------------------------ | -------------------------------------------------------------- |
| `id`          | `bigint` (PK)            | 레코드 식별자.                                                       |
| `symbol_id`   | `bigint` (FK→symbols.id) | 심볼 참조.                                                         |
| `timeframe`   | `varchar`                | 봉 간격. `5m`, `1h`, `1d` …                                       |
| `ts`          | `timestamptz`            | 봉 **마감** 시각 (UTC). 같은 `(symbol_id, timeframe, ts)` 조합은 1개만 존재. |
| `open`        | `numeric(18,4)`          | 해당 봉 시가.                                                       |
| `high`        | `numeric(18,4)`          | 고가.                                                            |
| `low`         | `numeric(18,4)`          | 저가.                                                            |
| `close`       | `numeric(18,4)`          | 종가. 지표 계산에 주로 사용.                                              |
| `volume`      | `numeric(18,0)`          | 거래량 (주/계약 수).                                                  |
| `ingested_at` | `timestamptz`            | 데이터가 ETL 파이프라인에 들어온 timestamp. 모니터링용.                          |

### 3. `indicators`

| 필드            | 타입              | 설명                       |
| ------------- | --------------- | ------------------------ |
| `id`          | `bigint` (PK)   | 레코드 식별자.                 |
| `symbol_id`   | `bigint`        | 심볼 참조.                   |
| `timeframe`   | `varchar`       | 봉 간격.                    |
| `ts`          | `timestamptz`   | 지표가 계산된 기준 시각 = 봉 마감 시각. |
| `rsi14`       | `numeric(10,4)` | 14 기간 RSI.               |
| `stoch_k`     | `numeric(10,4)` | 스토캐스틱 %K (9).            |
| `stoch_d`     | `numeric(10,4)` | 스토캐스틱 %D (6).            |
| `macd`        | `numeric(12,4)` | MACD Line (12,26).       |
| `macd_signal` | `numeric(12,4)` | MACD Signal (9 EMA).     |
| `adx14`       | `numeric(10,4)` | 14 기간 ADX.               |
| `cci14`       | `numeric(12,4)` | 14 기간 CCI.               |
| `atr14`       | `numeric(14,4)` | 14 기간 ATR.               |
| `highlow14`   | `numeric(12,4)` | 14 기간 High/Low 지표.       |
| `ultosc`      | `numeric(10,4)` | Ultimate Oscillator.     |
| `roc`         | `numeric(10,4)` | Rate of Change.          |
| `bull_bear`   | `numeric(14,4)` | Bull/Bear Power(13).     |
| `calc_at`     | `timestamptz`   | 지표 계산 완료 시각.             |

### 4. `moving_avgs`

| 필드                      | 타입              | 설명                                    |
| ----------------------- | --------------- | ------------------------------------- |
| `id`                    | `bigint` (PK)   | 레코드 식별자.                              |
| `symbol_id`             | `bigint`        | 심볼 참조.                                |
| `timeframe`             | `varchar`       | 봉 간격.                                 |
| `ts`                    | `timestamptz`   | 기준 봉 마감 시각.                           |
| `ma5`, `ema5` … `ma200` | `numeric(18,4)` | 각 기간별 단순/지수 이동평균. 5·10·20·50·100·200. |
| `calc_at`               | `timestamptz`   | 이동평균 계산 완료 시각.                        |

### 5. `summary`

| 필드            | 타입            | 설명                                                        |
| ------------- | ------------- | --------------------------------------------------------- |
| `id`          | `bigint` (PK) | 레코드 식별자.                                                  |
| `symbol_id`   | `bigint`      | 심볼 참조.                                                    |
| `timeframe`   | `varchar`     | 봉 간격.                                                     |
| `ts`          | `timestamptz` | 요약이 적용된 기준 시각 (봉 마감).                                     |
| `buy_cnt`     | `smallint`    | “매수”로 분류된 지표 개수.                                          |
| `sell_cnt`    | `smallint`    | “매도”로 분류된 지표 개수.                                          |
| `neutral_cnt` | `smallint`    | “중립” 지표 개수.                                               |
| `level`       | `varchar`     | 최종 레벨(STRONG\_BUY / BUY / NEUTRAL / SELL / STRONG\_SELL). |
| `scored_at`   | `timestamptz` | 레벨 산출 완료 시각.                                              |

## 인덱스 & 파티션 설계

| 테이블           | 인덱스 / 파티션                                    | 목적                |
| ------------- | -------------------------------------------- | ----------------- |
| `symbols`     | `UNIQUE(ticker)`                             | 중복 방지             |
| `candles_raw` | `UNIQUE(symbol_id, timeframe, ts)`           | 봉 중복 UPSERT       |
|               | `PARTITION BY RANGE (ts) INTERVAL '1 month'` | 월별 파티션 → 삭제/백업 용이 |
| `indicators`  | `UNIQUE(symbol_id, timeframe, ts)`           | 최신 레코드 찾기 O(1)    |
| `moving_avgs` | 동일                                           | —                 |
| `summary`     | `UNIQUE(symbol_id, timeframe, ts)`           | 레벨 변화 트래킹         |

## 데이터 흐름 요약

```
[yfinance] → candles_raw → indicators / moving_avgs → summary → FastAPI → UI & Discord
```



---